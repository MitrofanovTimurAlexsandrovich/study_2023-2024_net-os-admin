---
## Author
author:
  name: Митрофанов Тимур Александрович
  degrees: DSc
  orcid: 0000-0002-0877-7063
  email: 1132231842@pfur.ru
  affiliation:
    - name: Российский университет дружбы народов
      country: Российская Федерация
      postal-code: 117198
      city: Москва
      address: ул. Миклухо-Маклая, д. 6

## Title
title: "Отчёта по лабораторной работе 8"
subtitle: "Настройка SMTP-сервера"
license: "CC BY"
---

# Цель работы

Приобретение практических навыков по установке и конфигурированию SMTP сервера.

# Задание

1. Установите на виртуальной машине server SMTP-сервер postfix.
2. Сделайте первоначальную настройку postfix при помощи утилиты postconf, задав отправку писем не на локальный хост, а на сервер в домене.
3. Проверьте отправку почты с сервера и клиента.
4. Сконфигурируйте Postfix для работы в домене. Проверьте отправку почты с сервера и клиента.
5. Напишите скрипт для Vagrant, фиксирующий действия по установке и настройке Postfix во внутреннем окружении виртуальной машины server. Соответствующим образом внесите изменения в Vagrantfile.

# Выполнение лабораторной работы

На виртуальной машине server войдите под вашим пользователем и откройте терминал. Перейдите в режим суперпользователя. Установите необходимые для работы пакеты ([рис. @fig-001]).

![установка пакетов](image/1.png){#fig-001 width=70%}

Сконфигурируйте межсетевой экран, разрешив работать службе протокола SMTP ([рис. @fig-002]).

![конфигурация межсетевого экрана](image/2.png){#fig-002 width=70%}

Восстановите контекст безопасности в SELinux. Запустите Postfix ([рис. @fig-003]).

![Востановление безопасности и запуск Postfix](image/3.png){#fig-003 width=70%}

Для просмотра списка текущих настроек Postfix введите ([рис. @fig-004]).

![Ввод postconf](image/4.png){#fig-004 width=70%}

Посмотрите текущее значение параметра myorigin и Посмотрите текущее значение параметра mydomain ([рис. @fig-005]).

![просмотр значений myorigin и mydomain](image/5.png){#fig-005 width=70%}

Замените значение параметра myorigin на значение параметра mydomain ([рис. @fig-006]).

![замена значений](image/6.png){#fig-006 width=70%}

Проверьте корректность содержания конфигурационного файла main.cf.  Перезагрузите (перечитайте) конфигурационные файлы Postfix. Просмотрите все параметры с значением, отличным от значения по умолчанию. ([рис. @fig-007]).

![Проверка параметров и перезагрузка Postfix](image/7.png){#fig-007 width=70%}

Задайте жёстко значение домена (вместо user укажите свой логин). Отключите IPv6 в списке разрешённых в работе Postfix протоколов и оставьте только IPv4. Перезагрузите конфигурацию Postfix ([рис. @fig-008]).

![Задание жесткого значения и перезагрузка подсистем](image/8.png){#fig-008 width=70%}

На сервере под учётной записью пользователя отправьте себе письмо, используя утилиту mail ([рис. @fig-009]).

![отправка письма самому себе](image/9.png){#fig-009 width=70%}

На втором терминале запустите мониторинг работы почтовой службы и посмотрите, что произошло с вашим сообщением ([рис. @fig-010]).

### Анализ доставки сообщения

**Вывод:** Сообщение успешно доставлено.

**Обоснование из лога:**
Строка лога:
```
Oct 25 14:05:53 server postfix/local[8970]: 24C902268796: to=<tamitrofanov@server.tamitrofanov.net>, relay=local, delay=0.85, delays=0.03/0.02/0/0, dsn=2.0.0, status=sent (delivered to mailbox)
```

Ключевые показатели доставки:
- `dsn=2.0.0` - код успешной доставки (2.X.X коды означают успех)
- `status=sent` - явное указание на отправку
- `(delivered to mailbox)` - прямое указание на доставку в почтовый ящик

### Дополнительная проверка

Для полной проверки рекомендуется выполнить команду:
```bash
ls -la /var/spool/mail/
```

Ожидаемый результат - наличие файла с именем пользователя (tamitrofanov), который должен содержать доставленное письмо.

![cлужба логов](image/10.png){#fig-010 width=70%}

На клиенте установите необходимые для работы пакеты ([рис. @fig-011]).

![Умтановка пакетов](image/11.png){#fig-011 width=70%}

Отключите IPv6 в списке разрешённых в работе Postfix протоколов и оставьте только IPv4. На клиенте запустите Postfix ([рис. @fig-012]).

![отключение IPv6 и запуск Postfix](image/12.png){#fig-012 width=70%}

На клиенте под учётной записью пользователя аналогичным образом отправьте
себе второе письмо, используя утилиту mail. Сравните результат мониторинга почтовой службы на сервере при отправке сообщения с сервера и с клиента. В отчёте отразите, доставлено сообщение или нет. ([рис. @fig-013]).

![подтверждение недоставки писма по логам](image/13.png){#fig-013 width=70%}

На сервере в конфигурации Postfix посмотрите значения параметров сетевых интерфейсов inet_interfaces и сетевых адресов mynetworks ([рис. @fig-014]).

![Просмотр значений параментров](image/14.png){#fig-014 width=70%}

Разрешите Postfix прослушивать соединения не только с локального узла, но и с других интерфейсов сети. Добавьте адрес внутренней сети, разрешив таким образом пересылку сообщений между узлами сети. Перезагрузите конфигурацию Postfix и перезапустите Postfix ([рис. @fig-015]).

![настрайка Postfix](image/15.png){#fig-015 width=70%}

Повторите отправку сообщения с клиента. В отчёте отразите, что произошло с вашим сообщением ([рис. @fig-016]). ([рис. @fig-017]).

Логи подтверждают успешную доставку сообщения самому себе

![логи почты сервера](image/16.png){#fig-016 width=70%}

![логи почты клиента](image/17.png){#fig-017 width=70%}

Дополнительно посмотрите, какие сообщения ожидают в очереди на отправление ([рис. @fig-018]).

![Просмотр очереди почты](image/18.png){#fig-018 width=70%}

Для настройки возможности отправки сообщений не на конкретный узел сети,
а на доменный адрес пропишите MX-запись с указанием имени почтового сервера mail.user.net (вместо user укажите свой логин) в файле прямой DNS-зоны ([рис. @fig-019]).

и в файле обратной DNS-зоны:([рис. @fig-020]).

![настройка прямой зоны DNS](image/19.png){#fig-019 width=70%}

![настройка обратной зоны DNS](image/20.png){#fig-020 width=70%}

В конфигурации Postfix добавьте домен в список элементов сети, для которых данный сервер является конечной точкой доставки почты. Перезагрузите конфигурацию Postfix. Восстановите контекст безопасности в SELinux. . Перезапустите DNS. Попробуйте отправить сообщения, находящиеся в очереди на отправление.  ([рис. @fig-021]).

![Перенайстройка и перезапуск Postfix](image/21.png){#fig-021 width=70%}


Проверьте отправку почты с клиента на доменный адрес([рис. @fig-022]).

![логи почты](image/22.png){#fig-022 width=70%}

На виртуальной машине server перейдите в каталог для внесения изменений в настройки внутреннего окружения /vagrant/provision/server/. ([рис. @fig-023]).

![копирование конфигурационого файла](image/23.png){#fig-023 width=70%}

В каталоге /vagrant/provision/server создайте исполняемый файл mail.sh([рис. @fig-024]).

![создание конф. файла](image/24.png){#fig-024 width=70%}

Открыв его на редактирование, пропишите в нём следующий скрипт([рис. @fig-025]).

![содержимое файла mail.sh](image/25.png){#fig-025 width=70%}

На виртуальной машине client перейдите в каталог для внесения изменений в настройки внутреннего окружения /vagrant/provision/client/. В каталоге /vagrant/provision/client создайте исполняемый файл mail.sh([рис. @fig-026]).

![создание конф. файла](image/26.png){#fig-026 width=70%}

Открыв его на редактирование, пропишите в нём следующий скрипт ([рис. @fig-027]).

![содержимое конф. файла](image/27.png){#fig-027 width=70%}

Для отработки созданного скрипта во время загрузки виртуальной машины server в конфигурационном файле Vagrantfile необходимо добавить в разделе конфигурации для сервера ([рис. @fig-028]).

![добавленный код](image/28.png){#fig-028 width=70%}

Для отработки созданного скрипта во время загрузки виртуальной машины client в конфигурационном файле Vagrantfile необходимо добавить в разделе конфигурации для клиента ([рис. @fig-029]).

![добавленный код](image/29.png){#fig-029 width=70%}




# Выводы

В ходе выполнение лабораторной работы я приобрёл практические навыкы по установке и конфигурированию SMTP сервера.

# Список литературы{.unnumbered}

::: {#refs}
:::
