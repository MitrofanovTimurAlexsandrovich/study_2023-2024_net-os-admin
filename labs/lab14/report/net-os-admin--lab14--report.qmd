---
## Author
author:
  name: Митрофанов Тимур Александрович
  degrees: DSc
  orcid: 0000-0002-0877-7063
  email: 1132231842@pfur.ru
  affiliation:
    - name: Российский университет дружбы народов
      country: Российская Федерация
      postal-code: 117198
      city: Москва
      address: ул. Миклухо-Маклая, д. 6

## Title
title: "Лабораторная работа № 14"
subtitle: "Настройка файловых служб Samba"
license: "CC BY"
---

# Цель работы

Приобретение навыков настройки доступа групп пользователей к общим ресурсам по протоколу SMB.

# Задание

1. Установите и настройте сервер Samba.
2. Настройте на клиенте доступ к разделяемым ресурсам
3. Напишите скрипты для Vagrant, фиксирующие действия по установке и настройке сервера Samba для доступа к разделяемым ресурсам во внутреннем окружении виртуальных машин server и client. Соответствующим образом необходимо внести изменения в Vagrantfile.



# Выполнение лабораторной работы

На сервере установите необходимые пакеты ([рис. @fig-001])

![установка samba на сервер](image/1.png){#fig-001 width=70%}

Создайте группу sambagroup для пользователей, которые будут работать с Sambaсервером, и присвойте ей GID 1010. Добавьте пользователя user к группе sambagroup. Создайте общий каталог в файловой системе Linux, в который предполагается монтировать разделяемые ресурсы  ([рис. @fig-002])

![настройка прав доступа](image/2.png){#fig-002 width=70%}

В файле конфигурации /etc/samba/smb.conf измените параметр рабочей группы. В конце файла добавьте раздел с описанием общего доступа к разделяемому ресурсу /srv/sambashare  ([рис. @fig-003])

![изменение файла /etc/samba/smb.conf](image/3.png){#fig-003 width=70%}

Убедитесь, что вы не сделали синтаксических ошибок в файле smb.conf, используя команду: testparm([рис. @fig-004]).

![проверка файла smb.conf](image/4.png){#fig-004 width=70%}

Запустите демон Samba и посмотрите его статус. Для проверки наличия общего доступа попробуйте подключиться к серверу с помощью smbclient ([рис. @fig-005]).

![Запуск демона и проверка доступа](image/5.png){#fig-005 width=70%}

Посмотрите файл конфигурации межсетевого экрана для Samba([рис. @fig-006]).



![Просмотр файла конфигурации](image/6.png){#fig-006 width=70%}

Настройте межсетевой экран. Настройте права доступа для каталога с разделяемым ресурсом. Посмотрите контекст безопасности SELinux. Разрешите экспортировать разделяемые ресурсы для чтения и записи. Посмотрите UID вашего пользователя и в какие группы он включён. ([рис. @fig-007]).

![Настройка безопасности и доступа к файлам](image/7.png){#fig-007 width=70%}

Под вашим пользователем user попробуйте создать файл на разделяемом ресурсе([рис. @fig-008]).

![создание нового файла](image/8.png){#fig-008 width=70%}

Добавьте вашего пользователя user в базу пользователей Samba([рис. @fig-009]).

![добавление пользователя в Samba](image/9.png){#fig-009 width=70%}

На клиенте установите необходимые пакеты ([рис. @fig-010]).


![устновка утилит на клиент](image/10.png){#fig-010 width=70%}

На клиенте посмотрите файл конфигурации межсетевого экрана для клиента
Samba ([рис. @fig-011]).

![просмотр файла конфигурации](image/11.png){#fig-011 width=70%}

На клиенте настройте межсетевой экран. На клиенте создайте группу sambagroup и добавьте в неё пользователя user ([рис. @fig-012])

![настройка пользователя и межсетевого экрана](image/12.png){#fig-012 width=70%}

На клиенте в файле конфигурации /etc/samba/smb.conf измените параметр рабочей группы ([рис. @fig-013]).

![изменение файла /etc/samba/smb.conf](image/13.png){#fig-013 width=70%}
 
Для проверки наличия общего доступа попробуйте подключиться с клиента к серверу с помощью smbclient:
smbclient -L //server

В отчёте укажите, под какой учётной записью вы просматриваете ресурсы сервера. -> без указания пользователя, при запуске из под root. Просмотр файлов сервера был осуществлён через root - это можно понять при запросе пароля.


Подключитесь с клиента к серверу с помощью smbclient под учётной записью вашего пользователя (вместо user используйте ваш логин):
smbclient -L //server -U user

В отчёте укажите, под какой учётной записью вы просматриваете ресурсы сервера.-> при указании пользователя, при запуске из под root. Просмотр файлов сервера был осуществлён через tamitrofanov - это можно понять при запросе пароля. ([рис. @fig-014]).

![Просмотр файлов сервера через разных пользователей](image/14.png){#fig-014 width=70%}

На клиенте создайте точку монтирования. На клиенте получите доступ к общему ресурсу с помощью mount. Убедитесь, что user может записывать файлы на разделяемом ресурсе. Отмонтируйте каталог /mnt/samba ([рис. @fig-015]).

![Пробный монтаж и попытка работы с разделом](image/15.png){#fig-015 width=70%}

Для настройки работы с Samba с помощью файла учётных данных:

(a) на клиенте создайте файл smbusers в каталоге /etc/samba/. с содержанием следующего формата:

username=<username>

password=<password>

([рис. @fig-016]).

![Создание файла](image/16.png){#fig-016 width=70%}

На клиенте в файле /etc/fstab добавьте следующую строку. Подмонтируйте общий ресурс. ([рис. @fig-017]).

![редактирование файла и монтаж](image/17.png){#fig-017 width=70%}

Убедившись, что ресурс монтируется, вы можете перезагрузить клиента для проверки, что ресурс монтируется и после перезагрузки, а у пользователя есть доступ к разделяемым ресурсам. ([рис. @fig-018])

![Ребут и повторна проверка](image/18.png){#fig-018 width=70%}

На виртуальной машине server перейдите в каталог для внесения изменений в настройки внутреннего окружения /vagrant/provision/server/, создайте в нём каталог smb, в который поместите в соответствующие подкаталоги конфигурационные файлы.

В каталоге /vagrant/provision/server создайте исполняемый файл smb.sh. Открыв его на редактирование, пропишите в нём следующий скрипт ([рис. @fig-019])

![Создание скрипта для автоматического запуска утилиты на сервере](image/19.png){#fig-019 width=70%}

На виртуальной машине client перейдите в каталог для внесения изменений в настройки внутреннего окружения /vagrant/provision/client/, создайте в нём каталог smb, в который поместите в соответствующие подкаталоги конфигурационные файлы. В каталоге /vagrant/provision/client создайте исполняемый файл smb.sh. Открыв его на редактирование, пропишите в нём следующий скрипт. ([рис. @fig-020])

![Создание скрипта для автоматического запуска утилиты на клиенте](image/20.png){#fig-020 width=70%}

Для отработки созданных скриптов во время загрузки виртуальных машин server ([рис. @fig-021]) и client ([рис. @fig-022]) в конфигурационном файле Vagrantfile необходимо добавить в соответствующих разделах конфигураций для сервера и клиента 

![изменение внешнего конфиг файла для сервера](image/21.png){#fig-021 width=70%}

![изменение внешнего конфиг файла для клиенте](image/22.png){#fig-022 width=70%}

# Выводы

Сегодня я получил навыки настройки доступа групп пользователей к общим ресурсам по протоколу SMB.

# Список литературы{.unnumbered}

::: {#refs}
:::
