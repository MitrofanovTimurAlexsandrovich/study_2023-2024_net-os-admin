---
## Author
author:
  name: Митрофанов Тимур Александрович
  degrees: DSc
  orcid: 0000-0002-0877-7063
  email: 1132231842@pfur.ru
  affiliation:
    - name: Российский университет дружбы народов
      country: Российская Федерация
      postal-code: 117198
      city: Москва
      address: ул. Миклухо-Маклая, д. 6

## Title
title: "Отчёт по лабораторной работе 11"
subtitle: "Настройка безопасного удалённого доступа по протоколу SSH"
license: "CC BY"
---

# Цель работы

Приобретение практических навыков по настройке удалённого доступа к серверу с помощью SSH.

# Задание

1. Настройте запрет удалённого доступа на сервер по SSH для пользователя root (см. раздел 11.4.1).
2. Настройте разрешение удалённого доступа к серверу по SSH только для пользователей группы vagrant и вашего пользователя (см. раздел 11.4.2).
3. Настройте удалённый доступ к серверу по SSH через порт 2022 (см. раздел 11.4.3).
4. Настройте удалённый доступ к серверу по SSH по ключу (см. раздел 11.4.4).
5. Организуйте SSH-туннель с клиента на сервер, перенаправив локальное соединение с TCP-порта 80 на порт 8080 (см. раздел 11.4.5).
6. Используя удалённое SSH-соединение, выполните с клиента несколько команд на сервере (см. раздел 11.4.6).
7. Используя удалённое SSH-соединение, запустите с клиента графическое приложение на сервере (см. раздел 11.4.7).
8. Напишите скрипт для Vagrant, фиксирующий действия по настройке SSH-сервера во внутреннем окружении виртуальной машины server. Соответствующим образом внесите изменения в Vagrantfile (см. раздел 11.4.8).

# Выполнение лабораторной работы

На сервере задайте пароль для пользователя root, если этого не было сделано ранее ([рис. @fig-001]).

![смена настройки](image/1.png){#fig-001 width=70%}

На сервере в дополнительном терминале запустите мониторинг системных событий ([рис. @fig-002]).

![мониторинг](image/2.png){#fig-002 width=70%}

С клиента попытайтесь получить доступ к серверу посредством SSH-соединения через пользователя root ([рис. @fig-003]).

при поптке подключения создается отпечаток, но система запрещает войти под рутов в запись рут на сервере

![попытка входа под рутом](image/3.png){#fig-003 width=70%}

На сервере откройте файл /etc/ssh/sshd_config конфигурации sshd для редактирования и запретите вход на сервер пользователю root ([рис. @fig-004]).

![изменение файла](image/4.png){#fig-004 width=70%}

После сохранения изменений в файле конфигурации перезапустите sshd ([рис. @fig-005]).

![перезапуск службы](image/5.png){#fig-005 width=70%}

Повторите попытку получения доступа с клиента к серверу посредством SSHсоединения через пользователя root ([рис. @fig-006]).

![повторная попытка зайти под рутом и запрет сервера на это действие](image/6.png){#fig-006 width=70%}

П. С клиента попытайтесь получить доступ к серверу посредством SSH-соединения через пользователя user (вместо user укажите вашего пользователя) ([рис. @fig-007]).

система нас пускает

![подключение к пользователю на сервере](image/7.png){#fig-007 width=70%}

На сервере откройте файл /etc/ssh/sshd_config конфигурации sshd на редактирование и добавьте строку ([рис. @fig-008]).

![изменение конфига](image/8.png){#fig-008 width=70%}

После сохранения изменений в файле конфигурации перезапустите sshd
Повторите попытку получения доступа с клиента к серверу посредством ([рис. @fig-009]).



так как мы запретили иным польщователям кроме вгранта подключение нас перестаёт пускать

![попытка подключения к серверу](image/9.png){#fig-009 width=70%}

В файле /etc/ssh/sshd_config конфигурации sshd внесите следующее изменение ([рис. @fig-010]).

![изменение файла](image/10.png){#fig-010 width=70%}

После сохранения изменений в файле конфигурации перезапустите sshd и вновь попытайтесь получить доступ с клиента к серверу посредством SSH-соединения через пользователя user.
В отчёте поясните, что при этом происходит ([рис. @fig-011]).

так как мы прописали разрешение нашему пользователю на подключение нас пускает

![успешное подклбчение к серверу](image/11.png){#fig-011 width=70%}

На сервере в файле конфигурации sshd /etc/ssh/sshd_config найдите строку Port и ниже этой строки добавьте ([рис. @fig-012]).

![изменияем кофиг](image/12.png){#fig-012 width=70%}

После сохранения изменений в файле конфигурации перезапустите sshd ([рис. @fig-013]).

![перезапуск служб](image/13.png){#fig-013 width=70%}

Посмотрите расширенный статус работы sshd ([рис. @fig-014]).

проблема в том что нам надо шифрованое подключение на порту для безопасного подключения, но мы не указывали tcp на указанный порт

![проверяяем наличие ошибки](image/14.png){#fig-014 width=70%}

Исправьте на сервере метки SELinux к порту 2022. В настройках межсетевого экрана откройте порт 2022 протокола TCP. Вновь перезапустите sshd и посмотрите расширенный статус его работы. Статус
должен показать, что процесс sshd теперь прослушивает два порта. ([рис. @fig-015]).

![настрайка Postfix](image/15.png){#fig-015 width=70%}

С клиента попытайтесь получить доступ к серверу посредством SSH-соединения через пользователя user (вместо user укажите вашего пользователя). После открытия оболочки пользователя введите sudo -i для получения доступа root. Отлогиньтесь от root и вашего пользователя на сервере, введя дважды logout или используя дважды комбинацию клавиш Ctrl + d . ([рис. @fig-016]).

![обычное подключение к серверу](image/16.png){#fig-016 width=70%}

Повторите попытку получения доступа с клиента к серверу посредством SSH-соединения через пользователя user, указав порт 2022: ssh -p2022 user@server.user.net После открытия оболочки пользователя введите sudo -i для получения доступа root. Отлогиньтесь от root и вашего пользователя на сервере, введя дважды logout или используя дважды комбинацию клавиш Ctrl + d . ([рис. @fig-017]).

![поключение через новый порт](image/17.png){#fig-017 width=70%}

На сервере в конфигурационном файле /etc/ssh/sshd_config задайте параметр, разрешающий аутентификацию по ключу ([рис. @fig-018]).

![меняем кофигурационный файл](image/18.png){#fig-018 width=70%}

После сохранения изменений в файле конфигурации перезапустите sshd ([рис. @fig-019]).

![перезапуск служб](image/19.png){#fig-019 width=70%}

На клиенте сформируйте SSH-ключ, введя в терминале под пользователем user (вместо user используйте ваш логин): ssh-keygen Когда вас спросят, хотите ли вы использовать кодовую фразу, нажмите Enter , чтобы использовать установку без пароля. При запросе имени файла, в котором будет храниться закрытый ключ, примите предлагаемое по умолчанию имя файла (~/.ssh/id_rsa). Когда вас попросят ввести кодовую фразу, нажмите Enter дважды.
Скопируйте открытый ключ на сервер, введя на клиенте (вместо user укажите вашего пользователя) Попробуйте получить доступ с клиента к серверу посредством SSH-соединения (вместо user используйте ваш логин): ssh user@server.user.net Теперь вы должны пройти аутентификацию без ввода пароля для учётной записи удалённого пользователя. Отлогиньтесь с сервера, используя комбинацию клавиш Ctrl + d .([рис. @fig-020]).

![создание ключа и копирование ключа на сервер](image/20.png){#fig-020 width=70%}

На клиенте посмотрите, запущены ли какие-то службы с протоколом TCP  ([рис. @fig-021]).

![проверием запущенные службы](image/21.png){#fig-021 width=70%}


Перенаправьте порт 80 на server.user.net на порт 8080 на локальной машине
(вместо user используйте ваш логин) ([рис. @fig-022]).

![перенаправление](image/22.png){#fig-022 width=70%}

Вновь на клиенте посмотрите, запущены ли какие-то службы с протоколом TCP ([рис. @fig-023]).


Теперь у нас всёё ыремя шифрованный пртокол на порту 80

![проверием запущенные службы](image/23.png){#fig-023 width=70%}

На клиенте запустите браузер и в адресной строке введите localhost:8080. Убедитесь, что отобразится страница с приветствием «Welcome to the server.user.net server». ([рис. @fig-024]).

![проверка работы перенаправления](image/24.png){#fig-024 width=70%}

1. На клиенте откройте терминал под пользователем user (вместо user используйте
ваш логин).
2. Посмотрите с клиента имя узла сервера:
ssh user@server.user.net hostname
3. Посмотрите с клиента список файлов на сервере:
ssh user@server.user.net ls -Al
4. Посмотрите с клиента почту на сервере:
ssh user@server.user.net MAIL=~/Maildir/ mail
([рис. @fig-025]).

![проверка домтупа к серверу без пароля](image/25.png){#fig-025 width=70%}

На сервере в конфигурационном файле /etc/ssh/sshd_config разрешите отображать на локальном клиентском компьютере графические интерфейсы X11([рис. @fig-026]).

![изменения конф файла](image/26.png){#fig-026 width=70%}

Попробуйте с клиента удалённо подключиться к серверу и запустить графическое приложение, например firefox (вместо user используйте ваш логин) ([рис. @fig-027]).

![ткрываем удалённо браузер на сервере](image/27.png){#fig-027 width=70%}

На виртуальной машине server перейдите в каталог для внесения изменений в настройки внутреннего окружения /vagrant/provision/server/, создайте в нём каталог ssh, в который поместите в соответствующие подкаталоги конфигурационный файл sshd_config В каталоге /vagrant/provision/server создайте исполняемый файл ssh.sh ([рис. @fig-028]).

![сохранение файлов и их создание](image/28.png){#fig-028 width=70%}

ДОткрыв его на редактирование, пропишите в нём следующий скрипт ([рис. @fig-029]).

![новый скрипт](image/29.png){#fig-029 width=70%}

Для отработки созданного скрипта во время загрузки виртуальной машины server в конфигурационном файле Vagrantfile необходимо добавить в разделе конфигурации для сервера ([рис. @fig-030]).

![дополнение скрипта на основной системе](image/30.png){#fig-030 width=70%}


# Выводы

Сегодня я приобрёл практические навыки по настройке удалённого доступа к серверу с помощью SSH.

# Список литературы{.unnumbered}

::: {#refs}
:::
