---
## Author
author:
  name: Митрофанов Тимур Александрович
  degrees: DSc
  orcid: 0000-0002-0877-7063
  email: kulyabov-ds@rudn.ru
  affiliation:
    - name: Российский университет дружбы народов
      country: Российская Федерация
      postal-code: 117198
      city: Москва
      address: ул. Миклухо-Маклая, д. 6

## Title
title: "Лабораторная работа № 10"
subtitle: "Расширенные настройки SMTP-сервера"
license: "CC BY"
---

# Цель работы

Приобретение практических навыков по конфигурированию SMTP-сервера в части настройки аутентификации.


# Задание

1. Настройте Dovecot для работы с LMTP.
2. Настройте аутентификацию посредством SASL на SMTP-сервере.
3. Настройте работу SMTP-сервера поверх TLS.
4. Скорректируйте скрипт для Vagrant, фиксирующий действия расширенной настройки SMTP-сервера во внутреннем окружении виртуальной машины server 

# Выполнение лабораторной работы

На начальном этапе выполнения работы осуществляется вход в систему и переход в режим суперпользователя. Это необходимо для получения неограниченного доступа к конфигурационным файлам и возможности управления системными службами почтового сервера ([рис. @fig-001]).

Использование данной команды позволяет избежать проблем с правами доступа при редактировании критически важных объектов в каталоге dovecot и postfix. На экране виден терминал с приглашением командной строки для пользователя root, что подтверждает готовность среды к дальнейшим манипуляциям.

![Переход в режим суперпользователя на сервере](image/1.png){#fig-001}

Для оперативного отслеживания изменений в работе почтовой системы запускается мониторинг лог-файла в реальном времени. В окне терминала отображаются последние записи о запуске служб Dovecot и Postfix, что позволяет сразу увидеть возможные ошибки конфигурации ([рис. @fig-002]).

Мониторинг осуществляется через просмотр файла maillog, где фиксируются все события- от инициализации демонов до передачи конкретных сообщений. На данный момент службы запущены в стандартном режиме и готовы к приему команд для настройки протокола локальной доставки.

![Запуск мониторинга логов почтовой службы](image/2.png){#fig-002}

Следующим шагом в основном конфигурационном файле Dovecot активируется протокол LMTP. Это расширение позволяет организовать более эффективную локальную пересылку почты и применять фильтрацию на стороне сервера в момент доставки ([рис. @fig-003]).

В секции protocols добавляется значение lmtp рядом с уже существующими imap и pop3. Данное действие сообщает серверу о необходимости запуска соответствующего сервиса для взаимодействия с агентом передачи почты в лице Postfix.

![Активация протокола LMTP в основном конфиге Dovecot](image/3.png){#fig-003}

Для обеспечения взаимодействия между Dovecot и Postfix настраивается специальный unix-слушатель. В конфигурационном файле master.conf задаются параметры сокета, через который будет происходить обмен данными между службами ([рис. @fig-004]).

Устанавливаются права доступа 0600, а также назначаются владелец и группа postfix. Это гарантирует безопасность передачи данных, так как доступ к сокету будет иметь только почтовый агент, что предотвращает несанкционированный перехват сообщений внутри системы.

![Настройка LMTP сокета для взаимодействия с почтовым агентом](image/4.png){#fig-004}

После настройки сокета на стороне Dovecot необходимо указать Postfix использовать именно этот транспорт для доставки сообщений в почтовые ящики. С помощью специальной утилиты управления конфигурацией задается параметр транспорта ([рис. @fig-005]).

Команда устанавливает использование lmtp через указанный ранее путь к сокету. Это позволяет отказаться от прямой записи в файлы и перейти к более современному и гибкому механизму управления почтовыми очередями на этапе финальной доставки.

![Переопределение транспорта доставки в настройках Postfix](image/5.png){#fig-005}

Для корректной работы механизмов авторизации в файле настроек аутентификации изменяется формат имени пользователя. Установка специального шаблона позволяет отсекать доменную часть, оставляя только логин ([рис. @fig-006]).

Это изменение важно для унификации доступа, чтобы система воспринимала пользователя tamitrofanov одинаково, независимо от того, указано ли в почтовом клиенте полное имя с доменом или краткое. На скриншоте виден процесс редактирования параметра в текстовом редакторе.

![Изменение формата имени пользователя для аутентификации](image/6.png){#fig-006}

Чтобы внесенные изменения вступили в силу, производится перезапуск обеих ключевых служб. Сначала перезапускается Postfix для применения новых настроек транспорта, а затем Dovecot для инициализации сервиса LMTP ([рис. @fig-007]).

Использование системного менеджера служб позволяет убедиться, что демоны корректно завершили работу и запустились снова с обновленными параметрами. Отсутствие сообщений об ошибках в консоли косвенно подтверждает правильность правок в текстовых файлах.

![Перезапуск почтовых служб для применения настроек](image/7.png){#fig-007}

В окне мониторинга логов фиксируется первая успешная доставка сообщения через новый протокол. В записях отчетливо видна цепочка событий- соединение с локальным сокетом, передача данных и итоговый статус о сохранении письма в INBOX ([рис. @fig-008]).

Важным моментом является идентификатор сессии LMTP, который подтверждает, что доставка была выполнена именно через настроенный механизм. Логи также показывают, что сообщение было принято от клиента и успешно обработано сервером без задержек.

![Подтверждение успешной доставки почты в системных логах](image/8.png){#fig-008}

Проверка содержимого почтового ящика через консольную утилиту подтверждает фактическое получение письма. В списке входящих отображается новое сообщение с темой LMTP test, отправленное ранее для проверки работоспособности ([рис. @fig-009]).

На скриншоте виден интерфейс почтового клиента, где письмо помечено как новое. Это является финальным подтверждением того, что связка Postfix и Dovecot через LMTP транспорт работает корректно и почта попадает по назначению в каталог пользователя.

![Просмотр полученного тестового письма в почтовом ящике](image/9.png){#fig-009}

Переходим к настройке механизмов SASL для обеспечения безопасности. В файле master.conf определяется служба аутентификации, которая позволит Postfix проверять учетные данные пользователей через базу Dovecot ([рис. @fig-010]).

Настраиваются два слушателя- один для внутреннего обмена данными с Postfix, другой для работы с базой данных пользователей. Установка прав 0660 для первого сокета позволяет группам postfix и dovecot безопасно обмениваться информацией о подлинности клиентов.

![Конфигурирование службы аутентификации SASL в Dovecot](image/10.png){#fig-010}

С помощью команд управления конфигурацией Postfix настраивается на использование механизмов Dovecot для проверки подлинности. Указывается тип аутентификации и путь к ранее созданному сокету в приватном каталоге ([рис. @fig-011]).

Эти параметры связывают две службы в единый механизм обеспечения безопасности. Теперь при попытке отправить почту через сервер, Postfix будет обращаться к Dovecot за подтверждением легитимности пользователя, используя стандартные протоколы взаимодействия.

![Связывание Postfix с механизмом аутентификации Dovecot](image/11.png){#fig-011}

Важнейшим этапом является настройка ограничений для получателей сообщений. Формируется список правил, которые определяют, кому разрешено пересылать почту, а какие запросы должны быть отклонены для борьбы со спамом и несанкционированным использованием релея ([рис. @fig-012]).

В список включаются проверки на существование домена получателя, проверку локальных сетей и обязательное требование аутентификации для внешних клиентов. Порядок следования этих опций критичен для правильной работы фильтрации на входе.

![Настройка политик безопасности и ограничений для получателей](image/12.png){#fig-012}

Ограничивается список доверенных сетей только локальным интерфейсом сервера. Это стандартная мера безопасности, предотвращающая использование сервера как открытого релея для рассылки сообщений из интернета ([рис. @fig-013]).

Установка параметра mynetworks в значение локальной петли гарантирует, что любая попытка отправки почты не с самого сервера потребует обязательного прохождения процедуры аутентификации. На скриншоте зафиксировано выполнение команды обновления настроек.

![Ограничение списка доверенных сетей в параметрах Postfix](image/13.png){#fig-013}

В файле описания сервисов Postfix редактируются параметры демона smtp. Добавляются опции, активирующие поддержку SASL и применяющие специфические ограничения для входящих соединений на 25 порту ([рис. @fig-014]).

Внесение изменений непосредственно в конфигурацию сервиса позволяет переопределить глобальные настройки для конкретного порта. Здесь активируется включение проверки подлинности и дублируются правила фильтрации получателей для надежности.

![Редактирование параметров SMTP сервиса в файле master.cf](image/14.png){#fig-014}

После завершения настройки SASL вновь производится перезапуск сервисов для активации новых функций. Теперь сервер готов проверять учетные данные клиентов перед тем, как принять от них сообщение для дальнейшей пересылки ([рис. @fig-015]).

Консоль показывает последовательное выполнение команд рестарта. Важно, чтобы обе службы были перезапущены, так как они теперь зависят друг от друга в вопросах проверки прав доступа пользователей.

![Перезагрузка служб после настройки механизмов безопасности](image/15.png){#fig-015}

На стороне клиента подготавливается инструментарий для тестирования аутентификации. С помощью пакетного менеджера устанавливается утилита telnet, которая позволяет имитировать работу почтового клиента в ручном режиме ([рис. @fig-016]).

Установка производится из репозиториев операционной системы. Наличие данного инструмента необходимо для проверки того, как сервер отвечает на команды авторизации и выдает ли он правильные заголовки в ответ на приветствие EHLO.

![Установка утилиты telnet на клиентской машине](image/16.png){#fig-016}

Для прохождения аутентификации по протоколу PLAIN необходимо подготовить строку с логином и паролем в кодировке base64. С помощью командной строки формируется специальный зашифрованный блок данных ([рис. @fig-017]).

Строка содержит имя пользователя и пароль, разделенные нулевыми байтами, что соответствует требованиям протокола. Полученный результат в дальнейшем будет скопирован и вставлен в сессию telnet для подтверждения личности пользователя перед сервером.

![Генерация строки аутентификации в формате base64](image/17.png){#fig-017}

Осуществляется подключение к почтовому серверу через telnet на стандартный 25 порт. В ходе сессии отправляется команда приветствия, после чего сервер сообщает о поддержке метода аутентификации PLAIN ([рис. @fig-018]).

На скриншоте виден диалог- клиент отправляет EHLO, а сервер выдает список своих возможностей. В конце вводится команда AUTH с ранее сгенерированной строкой, что инициирует процесс проверки подлинности на стороне Dovecot.

![Имитация процесса аутентификации через telnet сессию](image/18.png){#fig-018}

Сервер возвращает статус об успешном прохождении проверки подлинности. Код 235 означает, что введенные данные верны и пользователь теперь имеет право отправлять сообщения через данный сервер ([рис. @fig-019]).

Это важный этап тестирования, доказывающий, что настроенная ранее связка SASL между Postfix и Dovecot работает правильно. Теперь сервер защищен от анонимных рассылок и требует идентификации для работы с почтой.

![Получение подтверждения успешной авторизации от сервера](image/19.png){#fig-019}

Для настройки защищенного соединения TLS производится копирование сертификатов. Временные сертификаты, созданные при установке Dovecot, переносятся в системные каталоги TLS для использования их почтовым сервером Postfix ([рис. @fig-020]).

Копируются как сам публичный сертификат, так и приватный ключ. Это позволяет активировать шифрование трафика, чтобы пароли и содержимое писем не передавались по сети в открытом виде. На скриншоте видны команды копирования файлов.

![Копирование сертификатов для настройки шифрования TLS](image/20.png){#fig-020}

Производится детальная настройка параметров TLS в конфигурации Postfix. Указываются пути к файлам сертификата и ключа, а также настраивается база данных для кэширования сессий шифрования ([рис. @fig-021]).

Устанавливается режим безопасности may, который позволяет серверу предлагать шифрование, но сохранять совместимость с клиентами, которые его не поддерживают. Это обеспечивает баланс между безопасностью и доступностью почтового сервиса.

![Конфигурирование параметров TLS шифрования в Postfix](image/21.png){#fig-021}

В файле конфигурации сервисов активируется специальный порт 587 для приема почты от клиентов (submission). Этот порт по умолчанию настроен на обязательное использование TLS и аутентификации.

Редактирование master.cf позволяет четко разделить трафик между серверами и трафик от конечных пользователей. Для порта 587 задаются жесткие политики безопасности, включая принудительное шифрование сессии перед началом передачи данных.

Для обеспечения доступности нового сервиса извне настраивается межсетевой экран. В список разрешенных служб добавляется smtp-submission, после чего правила фаервола перезагружаются

Этот шаг необходим, чтобы сетевые фильтры операционной системы не блокировали входящие соединения на порту 587. На скриншоте виден расширенный список сервисов, в котором теперь присутствует нужная запись, и подтверждение успешного применения настроек.

![Настройка правил межсетевого экрана для нового порта](image/22.png){#fig-023}

После внесения всех изменений в настройки безопасности и портов производится финальный перезапуск Postfix. Теперь сервер полноценно поддерживает прием почты через защищенный протокол с обязательной проверкой подлинности ([рис. @fig-023]).

Стабильный перезапуск без системных предупреждений свидетельствует о корректности синтаксиса всех добавленных параметров. Сервер готов к финальному тестированию защищенного соединения с использованием специализированных утилит.

![Финальный перезапуск Postfix после настройки TLS](image/23.png){#fig-024}

Для проверки TLS используется утилита openssl, которая позволяет установить защищенное соединение и просмотреть параметры сертификата. В выводе команды отображается информация о шифре, протоколе и успешной авторизации ([рис. @fig-024]).

На скриншоте видна подробная техническая информация о сессии, включая тип шифрования AES-256. После установления канала выполняется команда аутентификации, которая также завершается успешно, подтверждая полную работоспособность всех систем защиты.

![Проверка защищенного TLS соединения через openssl](image/24.png){#fig-025}

Для обеспечения сохранности настроек в среде автоматизации конфигурационные файлы копируются в каталог синхронизации Vagrant. Это позволит автоматически применять эти настройки при развертывании виртуальной машины в будущем ([рис. @fig-025]).

Процесс включает создание необходимых директорий и перенос файлов Dovecot и Postfix с подтверждением перезаписи старых версий. Таким образом, текущее состояние сервера фиксируется в репозитории проекта для дальнейшего использования.

![Копирование конфигураций в каталог автоматизации Vagrant](image/25.png){#fig-026}

Редактируется скрипт автоматической настройки сервера. В него вносятся все команды управления конфигурацией через postconf и инструкции по управлению службами, которые выполнялись вручную в ходе работы ([рис. @fig-026]).

Это превращает ручные действия в воспроизводимый код. Скрипт дополняется секциями настройки аутентификации, TLS и параметров LMTP, что гарантирует идентичность настроек при каждом новом запуске виртуального окружения.

![Обновление скрипта автоматической настройки сервера](image/26.png){#fig-027}

Аналогичные изменения вносятся в скрипт настройки клиентской машины. Добавляются команды для установки необходимых пакетов, таких как telnet и почтовый клиент Evolution, которые использовались для проверки ([рис @fig-027]).

Автоматизация установки инструментов тестирования позволяет быстро подготовить рабочее место клиента. На скриншоте виден процесс редактирования bash скрипта в текстовом редакторе nano, завершающий цикл настройки всей инфраструктуры.

![Редактирование скрипта инициализации клиентской машины](image/27.png){#fig-027}

# Выводы

В ходе выполнения лабораторной работы я приобрёл практические навыки по конфигурированию SMTP-сервера в части настройки аутентификации.

# Список литературы{.unnumbered}

--- {#refs}
---
