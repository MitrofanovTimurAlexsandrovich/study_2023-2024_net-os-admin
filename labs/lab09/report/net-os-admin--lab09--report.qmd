---
## Author
author:
  name: Митрофанов Тимур Александрович
  degrees: DSc
  orcid: 0000-0002-0877-7063
  email: kulyabov-ds@rudn.ru
  affiliation:
    - name: Российский университет дружбы народов
      country: Российская Федерация
      postal-code: 117198
      city: Москва
      address: ул. Миклухо-Маклая, д. 6

## Title
title: "Лабораторная работа № 9"
subtitle: "Настройка POP3/IMAP сервера"
license: "CC BY"
---

# Цель работы

Приобретение практических навыков по установке и простейшему конфигурированию POP3/IMAP-сервера.



# Задание

1. Установите на виртуальной машине server Dovecot и Telnet для дальнейшей проверки корректности работы почтового сервера
2. Настройте Dovecot.
3. Установите на виртуальной машине client программу для чтения почты Evolution и настройте её для манипуляций с почтой вашего пользователя. Проверьте корректность работы почтового сервера как с виртуальной машины server, так и с виртуальной машины client.
4. Измените скрипт для Vagrant, фиксирующий действия по установке и настройке Postfix и Dovecote во внутреннем окружении виртуальной машины server, создайте скрипт для Vagrant, фиксирующий действия по установке Evolution во внутреннем окружении виртуальной машины client. Соответствующим образом внесите изменения в Vagrantfile.
 

# Выполнение лабораторной работы

На виртуальной машине server пользователь переходит в режим суперпользователя с помощью команды sudo -i. Это действие открывает доступ к административным привилегиям, которые требуются для установки системного программного обеспечения и изменения конфигурации сетевых служб.

Следом запускается команда dnf для установки пакетов dovecot и telnet. Утилита telnet в данном случае выступает инструментом для последующей диагностики и проверки доступности почтовых портов в ручном режиме ([рис. @fig-001]).

![Установка Dovecot и Telnet на сервере](image/1.png){#fig-001}

Производится редактирование основного конфигурационного файла dovecot по пути etc dovecot dovecot.conf. В текстовом редакторе nano осуществляется поиск и активация параметра, определяющего список обслуживаемых протоколов.

В строку protocols вносятся значения imap и pop3. Это позволяет серверу обрабатывать запросы от почтовых клиентов по обоим стандартам, обеспечивая гибкость при получении электронных сообщений пользователями ([рис. @fig-002]).

![Настройка поддерживаемых протоколов в dovecot.conf](image/2.png){#fig-002}

В файле конфигурации аутентификации 10-auth.conf проверяется параметр auth mechanisms. Здесь устанавливается метод plain, который является стандартным способом передачи учетных данных в открытом виде для базовой настройки системы.

Такая конфигурация необходима для того, чтобы сервер мог сопоставлять логины и пароли пользователей. На данном этапе важно убедиться, что выбранный механизм поддерживается установленными в системе базами данных пользователей ([рис. @fig-003]).

![Выбор механизмов аутентификации в 10-auth.conf](image/3.png){#fig-003}

Выполняется настройка параметров взаимодействия с системными базами данных в файле auth-system.conf.ext. Указывается использование драйвера pam для проверки паролей, что позволяет интегрировать Dovecot с общей системой безопасности Linux.

Для базы данных пользователей выбирается драйвер passwd. Это гарантирует, что почтовая служба будет корректно определять домашних пользователей системы, сопоставляя их имена с информацией в файле etc passwd ([рис. @fig-004]).

![Конфигурация драйверов passdb и userdb](image/4.png){#fig-004}

В конфигурационном файле 10-mail.conf определяется местоположение почтовых ящиков. Выбирается формат Maildir, который хранит каждое письмо в отдельном файле, что повышает надежность и производительность при работе с большим объемом почты.

Параметр mail location устанавливается в значение maildir:~/Maildir. Это указывает серверу создавать и искать почтовые хранилища непосредственно в домашних директориях пользователей, обеспечивая логичное разделение данных ([рис. @fig-005]).

![Определение пути к почтовым ящикам в 10-mail.conf](image/5.png){#fig-005}

Для обеспечения совместной работы почтовых служб используется утилита postconf. С ее помощью вносятся изменения в настройки Postfix, чтобы он доставлял входящую почту в тот же каталог, который был настроен для Dovecot.

Команда устанавливает значение параметра home mailbox равным Maildir/. Это критически важный шаг для синхронизации агента передачи почты (MTA) и агента доставки (MDA), чтобы они использовали единое хранилище ([рис. @fig-006]).

![Синхронизация Postfix с форматом Maildir](image/6.png){#fig-006}

Настройка сетевого экрана осуществляется через firewall-cmd для открытия доступа к почтовым службам. Вносятся правила для постоянного разрешения трафика по протоколам pop3, pop3s, imap и imaps.

После добавления всех необходимых сервисов выполняется перезагрузка конфигурации межсетевого экрана командой reload. Завершается этап проверкой списка активных служб, чтобы убедиться в готовности сервера принимать внешние подключения ([рис. @fig-007]).

![Разрешение почтовых протоколов в брандмауэре](image/7.png){#fig-007}

Выполняется восстановление контекстов безопасности SELinux для директории etc с помощью команды restorecon. Это необходимо для предотвращения блокировок доступа служб к своим конфигурационным файлам со стороны системы принудительного контроля доступа.

Затем производится перезапуск службы postfix и полная активация dovecot. Команды enable и start гарантируют, что почтовый сервер будет запущен немедленно и автоматически загрузится при последующих стартах системы ([рис. @fig-008]).

![Запуск почтовых служб и настройка прав доступа](image/8.png){#fig-008}

Запускается мониторинг системного лога maillog в режиме реального времени с помощью команды tail -f. Это позволяет администратору наблюдать за процессом инициализации почтовых демонов и фиксировать возможные ошибки при запуске.

В выводе лога фиксируется успешный старт Postfix и Dovecot. Появление строки о готовности master процесса Dovecot обслуживать протоколы imap и pop3 свидетельствует о правильном завершении этапа базовой настройки ([рис. @fig-009]).

![Просмотр логов запуска почтовой системы](image/9.png){#fig-009}

Производится попытка просмотра почты через локальную консольную утилиту mail. Для этого устанавливается переменная окружения MAIL, указывающая на созданный каталог Maildir в домашней папке пользователя root.

Система возвращает уведомление об отсутствии почты для пользователя. Данный результат является ожидаемым на свежеустановленном сервере, так как тестовые сообщения еще не отправлялись и ящик пуст ([рис. @fig-010]).

![Проверка почтового ящика через консоль](image/10.png){#fig-010}

Для более детальной проверки состояния почтовых хранилищ используется специализированная утилита doveadm. Команда mailbox list применяется к конкретному пользователю tamitrofanov для отображения структуры его папок.

Результат работы команды показывает наличие папки INBOX. Это подтверждает, что Dovecot успешно инициализировал структуру Maildir для данного пользователя и готов к приему сообщений в основной входящий ящик ([рис. @fig-011]).

![Просмотр списка почтовых папок через doveadm](image/11.png){#fig-011}

Работа переносится на виртуальную машину client, где требуется установить графический почтовый клиент Evolution. Процесс установки инициируется через менеджер пакетов dnf от имени суперпользователя.

Evolution выбран как полноценный инструмент для проверки работы сервера с точки зрения конечного пользователя. Установка данного ПО позволит протестировать как отправку по SMTP, так и получение писем по протоколу IMAP ([рис. @fig-012]).

![Установка почтового клиента Evolution на стороне клиента](image/12.png){#fig-012}

В мастере настройки Evolution на этапе Identity вводятся персональные данные пользователя. Указывается полное имя и адрес электронной почты в домене tamitrofanov.net, соответствующем настройкам сервера.

Эти данные будут использоваться в заголовках исходящих писем для идентификации отправителя. Правильное заполнение полей необходимо для корректной маршрутизации почты внутри созданной виртуальной сети ([рис. @fig-013]).

![Настройка идентификационных данных пользователя](image/13.png){#fig-013}

Настраивается сервер входящей почты с использованием протокола IMAP. В качестве адреса сервера указывается доменное имя почтового узла, а также устанавливается стандартный порт 143.

Особое внимание уделяется безопасности: выбирается метод шифрования STARTTLS. Это обеспечит защиту учетных данных пользователя tamitrofanov при авторизации и передаче сообщений между клиентом и сервером ([рис. @fig-014]).

![Параметры подключения к серверу IMAP](image/14.png){#fig-014}

Конфигурируется агент отправки почты (SMTP) для взаимодействия с сервером. Указывается адрес почтового шлюза и стандартный 25 порт, который был ранее открыт в настройках сетевого экрана сервера.

Для обеспечения целостности процесса также активируется поддержка STARTTLS. Использование этого метода позволяет перевести незащищенное соединение в зашифрованный режим сразу после установления связи ([рис. @fig-015]).

![Настройка параметров отправки почты по SMTP](image/15.png){#fig-015}

Создается тестовое электронное сообщение в интерфейсе Evolution. Письмо адресуется самому себе (самоотправка) для проверки полного цикла прохождения почты через настроенную систему.

В теле письма и теме указывается проверочное слово test. Нажатие кнопки Send инициирует процесс передачи данных на сервер, где Postfix должен принять сообщение и передать его в хранилище Maildir через механизмы Dovecot ([рис. @fig-016]).

![Создание и отправка тестового письма](image/16.png){#fig-016}

На скриншоте представлен комбинированный вид: слева окно клиента Evolution с папкой отправленных писем, справа — терминал сервера с открытыми логами. Видно, что в папке Sent появилось подтверждение успешной отправки двух тестов.

Лог файлы на сервере подтверждают активность процессов postfix cleanup и local. Записи свидетельствуют о том, что сообщение было успешно доставлено в каталог maildir пользователя, что подтверждает работоспособность всей цепочки ([рис. @fig-017]).

![Верификация доставки почты через логи сервера](image/17.png){#fig-017}

Осуществляется ручная проверка работы протокола POP3 с помощью утилиты telnet на порту 110. Последовательно вводятся команды протокола: USER для указания логина и PASS для аутентификации пользователя.

Команда LIST показывает количество и размер накопленных сообщений. С помощью RETR 1 выводится содержимое первого письма, а команда DELE 2 помечает второе сообщение на удаление, что демонстрирует полное управление ящиком через терминал ([рис. @fig-018]).

![Тестирование протокола POP3 через telnet](image/18.png){#fig-018}

Производится редактирование скрипта автоматизации mail.sh для серверной части в среде Vagrant. В файл вносятся команды для автоматической установки пакетов, настройки межсетевого экрана и параметров Postfix.

Скрипт также содержит инструкции по управлению службами, обеспечивая их автоматический запуск. Это позволяет воспроизвести всю настройку сервера на новой виртуальной машине без ручного ввода команд, экономя время администратора ([рис. @fig-019]).

![Скрипт автоматизации настройки почтового сервера](image/19.png){#fig-019}

Аналогичным образом подготавливается скрипт для настройки клиентской машины. В него включены команды установки почтового клиента и минимальной конфигурации локальной почтовой службы для корректной работы сетевых протоколов.

Автоматизация процесса настройки клиента гарантирует, что рабочее окружение пользователя будет иметь все необходимые инструменты для тестирования почты сразу после развертывания стенда. На этом выполнение практической части работы завершено ([рис. @fig-020]).

![Скрипт автоматизации настройки клиентской машины](image/20.png){#fig-020}

# Выводы

В ходе выполнения лабораторной работы я приобрёл практические навыки по установке и простейшему конфигурированию POP3/IMAP-сервера.

# Список литературы{.unnumbered}

--- {#refs}
---
