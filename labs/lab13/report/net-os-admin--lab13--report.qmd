---
## Author
author:
  name: Митрофанов Тимур Александрович
  degrees: DSc
  orcid: 0000-0002-0877-7063
  email: 1132231842@pfur.ru
  affiliation:
    - name: Российский университет дружбы народов
      country: Российская Федерация
      postal-code: 117198
      city: Москва
      address: ул. Миклухо-Маклая, д. 6

## Title
title: "Лабораторная работа № 13"
subtitle: " Настройка NFS"
license: "CC BY"
---

# Цель работы

Приобретение навыков настройки сервера NFS для удалённого доступа к ресурсам.

# Задание

1. Установите и настройте сервер NFSv4.
2. Подмонтируйте удалённый ресурс на клиенте.
3. Подключите каталог с контентом веб-сервера к дереву NFS
4. Подключите каталог для удалённой работы вашего пользователя к дереву NFS
5. Напишите скрипты для Vagrant, фиксирующие действия по установке и настройке сервера NFSv4 во внутреннем окружении виртуальных машин server и client. Соответствующим образом внесите изменения в Vagrantfile



# Выполнение лабораторной работы

На сервере установите необходимое программное обеспечение ([рис. @fig-001])

![установка nfs-utils](image/1.png){#fig-001 width=70%}

На сервере создайте каталог, который предполагается сделать доступным всем пользователям сети (корень дерева NFS) ([рис. @fig-002])

![создание коталога](image/2.png){#fig-002 width=70%}

В файле /etc/exports пропишите подключаемый через NFS общий каталог с доступом только на чтение ([рис. @fig-003])

![изменение файла](image/3.png){#fig-003 width=70%}

Для общего каталога задайте контекст безопасности NFS. Примените изменённую настройку SELinux к файловой системе. Запустите сервер NFS. Настройте межсетевой экран для работы сервера NFS([рис. @fig-004]).

![Настройка NSF](image/4.png){#fig-004 width=70%}

На клиенте установите необходимое для работы NFS программное обеспечение([рис. @fig-005]).

![установка nfs-utils](image/5.png){#fig-005 width=70%}

На клиенте попробуйте посмотреть имеющиеся подмонтированные удалённые
ресурсы (вместо user укажите свой логин)([рис. @fig-006]).

В отчёте поясните, что при этом происходит -> Команда `showmount` завершилась ошибкой `RPC: Unable to receive`. Это означает, что клиент не может установить связь с сервером NFS (`server.tamitrofanov.net`). Причиной чаще всего является то, что на сервере не запущены или заблокированы фаерволом необходимые службы NFS (rpcbind, nfs-server).

![Проверка удалённых ресов](image/6.png){#fig-006 width=70%}

Попробуйте на сервере остановить сервис межсетевого экрана. Затем на клиенте вновь попробуйте подключиться к удалённо смонтированному ресурсу ([рис. @fig-007]).

В отчёте поясните, что при этом происходит -> После отключения межсетевого экрана подключение пршло успешно

![отключение служюы и повторная проверка](image/7.png){#fig-007 width=70%}

На сервере запустите сервис межсетевого экрана([рис. @fig-008]).

![запуск межсетевого экрана](image/8.png){#fig-008 width=70%}

На сервере посмотрите, какие службы задействованы при удалённом монтировании:
lsof | grep TCP ([рис. @fig-009]).

lsof | grep UDP ([рис. @fig-010]).

![lsof | grep TCP](image/9.png){#fig-009 width=70%}

![lsof | grep UDP](image/10.png){#fig-010 width=70%}

Добавьте службы rpc-bind и mountd в настройки межсетевого экрана на сервере. На клиенте проверьте подключение удалённого ресурса ([рис. @fig-011]).

![внесение изменений в межсетевой экран и проверка поключения](image/11.png){#fig-011 width=70%}

На клиенте создайте каталог, в который будет монтироваться удалённый ресурс, и подмонтируйте дерево NFS ([рис. @fig-012])

Проверьте, что общий ресурс NFS подключён правильно. В отчёте поясните выведенную информацию о монтировании удалённого ресурса -> NFS подключён. */srv/nfs* - удалённый ресурс, * /mnt/nfs* - точка монтирования на клиенте

[создание каталога и его подмотирование](image/12.png){#fig-012 width=70%}

На клиенте в конце файла /etc/fstab добавьте следующую запись ([рис. @fig-013]).

В отчёте поясните синтаксис этой записи - *server.user.net:/srv/nfs* - файл на удалённом сервере,  */mnt/nfs* - дериктория на клиенте, *nfs* - тип файловой системы *_netdev 0 0* - файл должен монтироваться только после загрузки сети. 0 - не нужно делать резервную копию, 0 - не проверять файловую систему

![изменение файла](image/13.png){#fig-013 width=70%}
 
На клиенте проверьте наличие автоматического монтирования удалённых ресурсов при запуске операционной системы ([рис. @fig-014]).

![systemctl status remote-fs.target](image/14.png){#fig-014 width=70%}

Перезапустите клиента и убедитесь, что удалённый ресурс подключается автоматически ([рис. @fig-015]).

![доп проверка успешного подключения](image/15.png){#fig-015 width=70%}

На сервере создайте общий каталог, в который затем будет подмонтирован каталог с контентом веб-сервера. Подмонтируйте каталог web-сервера. 

В каталоге /vagrant/provision/client создайте исполняемый файл ntp.sh. На сервере проверьте, что отображается в каталоге /srv/nfs([рис. @fig-016]).

![Создание общего католога с конентом веб сервера](image/16.png){#fig-016 width=70%}

На клиенте посмотрите, что отображается в каталоге /mnt/nfs ([рис. @fig-017]).

![Проверка на клиенте](image/17.png){#fig-017 width=70%}

На сервере в файле /etc/exports добавьте экспорт каталога веб-сервера с удалённого ресурса ([рис. @fig-018])

![изменение файла](image/18.png){#fig-018 width=70%}

Экспортируйте все каталоги, упомянутые в файле /etc/exports ([рис. @fig-019])

![экспорт файлов](image/19.png){#fig-019 width=70%}

Проверьте на клиенте каталог /mnt/nfs([рис. @fig-020])

![проверка клиента](image/20.png){#fig-020 width=70%}

На сервере в конце файла /etc/fstab добавьте следующую запись ([рис. @fig-021])

![изменение файла на сервере](image/21.png){#fig-021 width=70%}

Повторно экспортируйте каталоги, указанные в файле /etc/exports([рис. @fig-022])

![повторный экспорт файлов](image/22.png){#fig-022 width=70%}

На клиенте проверьте каталог /mnt/nfs ([рис. @fig-023])

![проверка клиента](image/23.png){#fig-023 width=70%}

На сервере под пользователем user в его домашнем каталоге создайте каталог common с полными правами доступа только для этого пользователя, а в нём файл user@server.txt (вместо user укажите свой логин), На сервере создайте общий каталог для работы пользователя user по сети, Подмонтируйте каталог common пользователя user в NFS. В отчёте укажите, какие права доступа установлены на этот каталог -> Команда `mount -o bind` создает привязку каталога, но не меняет исходные права доступа. Права доступа на каталог `/srv/nfs/home/user` будут точно такими же, как и на исходном каталоге `/home/user/common`.([рис. @fig-024])

![экспорт файлов](image/24.png){#fig-024 width=70%}

Подключите каталог пользователя в файле /etc/exports, прописав в нём([рис. @fig-025])

![изменение файла](image/25.png){#fig-025 width=70%}

Внесите изменения в файл /etc/fstab ([рис. @fig-026])

![изменение файла](image/26.png){#fig-026 width=70%}

Повторно экспортируйте каталоги ([рис. @fig-027])

![экспорт файлов](image/27.png){#fig-027 width=70%}

На клиенте проверьте каталог /mnt/nfs([рис. @fig-028])

![проверка клиента](image/28.png){#fig-028 width=70%}

На клиенте под пользователем user перейдите в каталог /mnt/nfs/home/user
и попробуйте создать в нём файл user@client.txt и внести в него какие-либо изменения([рис. @fig-029]) Попробуйте проделать это под пользователем root ([рис. @fig-030])

![экспорт файлов](image/29.png){#fig-029 width=70%}

![экспорт файлов](image/30.png){#fig-030 width=70%}

На сервере посмотрите, появились ли изменения в каталоге пользователя
/home/user/common([рис. @fig-031])

изменения проявились

![проверка изменения файлов на сервере](image/31.png){#fig-031 width=70%}

На виртуальной машине server перейдите в каталог для внесения изменений в настройки внутреннего окружения /vagrant/provision/server/, создайте в нём каталог nfs, в который поместите в соответствующие подкаталоги конфигурационные файлы. В каталоге /vagrant/provision/server создайте исполняемый файл nfs.sh([рис. @fig-032])

![Создание конфиг файла](image/32.png){#fig-032 width=70%}

Открыв его на редактирование, пропишите в нём следующий скрипт([рис. @fig-033])

![изменение конфиг файла](image/33.png){#fig-033 width=70%}

На виртуальной машине client перейдите в каталог для внесения изменений в настройки внутреннего окружения /vagrant/provision/client/. В каталоге /vagrant/provision/client создайте исполняемый файл nfs.sh([рис. @fig-034])

![Создание конфиг файла](image/34.png){#fig-034 width=70%}

На виртуальной машине client перейдите в каталог для внесения изменений в настройки внутреннего окружения /vagrant/provision/client/([рис. @fig-035])

![изменение конфиг файла](image/35.png){#fig-035 width=70%}

Для отработки созданных скриптов во время загрузки виртуальных машин server ([рис. @fig-036]) и client ([рис. @fig-037]) в конфигурационном файле Vagrantfile необходимо добавить в соответствующих разделах конфигураций для сервера и клиента

![изменение внешнего конфиг файла для сервера](image/36.png){#fig-037 width=70%}

![изменение внешнего конфиг файла для сервера](image/37.png){#fig-037 width=70%}

# Выводы

Сегодня я получил навыки настройки сервера NFS для удалённого доступа к ресурсам.

# Список литературы{.unnumbered}

::: {#refs}
:::
